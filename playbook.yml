---
- name: Configure all for ansible management
  hosts: all
  tags: [bootstrap]
  remote_user: root
  gather_facts: no
  roles:
    - role: robertdebock.bootstrap
    - role: robertdebock.hostname
    - role: geerlingguy.swap
    - role: robertdebock.users
      users:
        - name: ansible
          comment: Ansible login for use after root SSH is disabled
          authorized_keys:
          - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINCvCQlRUXmMiAdN0pzqpmAULLaEuVt3dzL0xEc8ZyKc"
    - role: geerlingguy.security

- name: Configure base requirements
  hosts: all
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  tasks:
  - name: Manyfold Network
    community.docker.docker_network:
      name: manyfold
      enable_ipv6: true
  - name: Fediscoverer Network
    community.docker.docker_network:
      name: fediscoverer
      enable_ipv6: true
  roles:
    - role: docker-maintenance

- name: Set up Caddy frontend
  hosts: [lb]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - role: caddy

- name: Set up tracking app
  hosts: [tracker]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - role: tracking

- name: Set up Manyfold
  hosts: [app]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - role: manyfold
    - role: fediscoverer

- name: Set up Manyfold Solo
  hosts: [try]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - role: manyfold-solo


- name: Set up database server
  hosts: [db]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - postgresql

- name: Set up cache server
  hosts: [cache]
  remote_user: ansible
  port: "{{security_ssh_port}}"
  become: yes
  roles:
    - valkey
